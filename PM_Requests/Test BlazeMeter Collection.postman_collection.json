{
	"info": {
		"_postman_id": "0e5b6d23-9d54-4e43-aa1e-04273c0b592e",
		"name": "Test BlazeMeter Collection",
		"description": "This will demonstrate postman test suite execution using BlazeMeter\n\nWe will persist all env variables\n1. Get the IP and a random uuid. from http bin\n2. Using the first integer, get the user id from jsonplaceholder\n3. Using the user's name and the uuid, create a cookie from httpbin\n4. Post to /anything and make assertions",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "GET IP Address from HTTPBIN",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "15ebf321-e66e-43e6-9fd3-11304823caa6",
						"exec": [
							"let testRunNumber = pm.environment.get(\"testRunNumber\");",
							"console.log(\"===== TEST RUN #\"+ testRunNumber + \"==========\");",
							"pm.environment.set(\"testRunNumber\", ++testRunNumber);",
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "3f3af03e-d618-4637-8f84-e1838767f8f1",
						"exec": [
							"//Test",
							"pm.test(\"Body contains origin\", function () {",
							"    pm.expect(pm.response.text()).to.include(\"origin\");",
							"});",
							"",
							"",
							"if(pm.response.code === 200){",
							"const { origin } = pm.response.json();",
							"pm.environment.set(\"ipAddress\", origin);",
							"console.log(\"IP Address: \" + pm.environment.get(\"ipAddress\"));",
							"postman.setNextRequest('GET Random User');",
							"} else{",
							"    console.log(\"Failure. Stopping workflow\");",
							"    postman.setNextRequest(null);",
							"}",
							"",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{urlA}}/ip",
					"host": [
						"{{urlA}}"
					],
					"path": [
						"ip"
					]
				},
				"description": "This request returns an IP Addresss. "
			},
			"response": []
		},
		{
			"name": "GET Random User",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "c5341cc5-5888-4a17-8bfe-8ff583a2651c",
						"exec": [
							"pm.environment.set(\"userID\", Math.floor(Math.random() * 10)+1 );",
							"console.log(\"Set userID to \" + pm.environment.get(\"userID\"));"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "d8d8c65b-1b4f-4b16-b817-ee4ca695a31e",
						"exec": [
							"//Test",
							"const jsonData = pm.response.json();",
							"pm.test(\"Returned ID is expected\", function () {",
							"    pm.expect(jsonData.id).to.eql(pm.environment.get(\"userID\"));",
							"});",
							"",
							"//Make Cookie",
							"const { username } = jsonData;",
							"pm.environment.set(\"cookieName\", username + \"_cookie\");",
							"pm.environment.set(\"cookieValue\", 'ID-' + pm.environment.get(\"userID\") +  ",
							"    '-IP-' + pm.environment.get(\"ipAddress\") );",
							"",
							"//Next in workflow",
							"if(pm.response.code === 200){",
							" postman.setNextRequest('Set Cookie');   ",
							"",
							"} else{",
							"    console.log(\"Failure. Stopping workflow\");",
							"    postman.setNextRequest(null);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{urlB}}/users/{{userID}}",
					"host": [
						"{{urlB}}"
					],
					"path": [
						"users",
						"{{userID}}"
					]
				},
				"description": "Sets the userID to a random number, then fetches the user info of that userID"
			},
			"response": []
		},
		{
			"name": "Set Cookie",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "8f7845ed-912b-4322-b595-13f20bf7c63c",
						"exec": [
							"//Test",
							"const cookieName = pm.environment.get(\"cookieName\");",
							"const { cookies } = pm.response.json();",
							"",
							"pm.test(\"Cookie has been added\", function () {",
							"    pm.expect(JSON.stringify(cookies)).to.include(cookieName);",
							"});",
							"pm.test(\"Value of cookie is as expected\", function () {",
							"    pm.expect(cookies[cookieName]).to.eql(pm.environment.get(\"cookieValue\"));",
							"});",
							"",
							"//Conditional workflow",
							"//if username count is even return 200 else return 500",
							"//for kicks let's use substring",
							"const username = cookieName.substring(0,cookieName.length-7);",
							"//add the test run number because apparently lots of the names have an even length",
							"const testRunNumber = pm.environment.get(\"testRunNumber\");",
							"const isOdd =username.length + testRunNumber %2;",
							"console.log(isOdd);",
							"const evensOrOdds = isOdd ? \"Odds!\" : \"Evens!\";",
							"console.log(evensOrOdds);",
							"pm.environment.set(\"flowFollowed\", evensOrOdds);",
							"if(isOdd) postman.setNextRequest('Return 500 Status');",
							"else postman.setNextRequest('Return 200 Status');",
							"",
							"    "
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "CookieCrisp",
						"value": "1234",
						"type": "text",
						"disabled": true
					}
				],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{urlA}}/cookies/set/{{cookieName}}/{{cookieValue}}",
					"host": [
						"{{urlA}}"
					],
					"path": [
						"cookies",
						"set",
						"{{cookieName}}",
						"{{cookieValue}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Return 500 Status",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "1daebe3f-1d37-4b1a-884e-24d49371a11c",
						"exec": [
							"//Test",
							"",
							"pm.test(\"Status code is 500\", function () {",
							"    pm.response.to.have.status(500);",
							"});",
							"let testedOdds = pm.environment.get(\"testedOdds\");",
							"pm.environment.set(\"testedOdds\", ++testedOdds);",
							"",
							"postman.setNextRequest('Final Blaze Request');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{urlA}}/status/500",
					"host": [
						"{{urlA}}"
					],
					"path": [
						"status",
						"500"
					]
				},
				"description": "Will return 500 every time"
			},
			"response": []
		},
		{
			"name": "Return 200 Status",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "1daebe3f-1d37-4b1a-884e-24d49371a11c",
						"exec": [
							"//Test",
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"let testedEvens = pm.environment.get(\"testedEvens\");",
							"pm.environment.set(\"testedEvens\", ++testedEvens);",
							"postman.setNextRequest('Final Blaze Request');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{urlA}}/status/200",
					"host": [
						"{{urlA}}"
					],
					"path": [
						"status",
						"200"
					]
				},
				"description": "Will return 500 every time"
			},
			"response": []
		},
		{
			"name": "Final Blaze Request",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "f7d8c852-19ed-409f-830d-d962e10fd1bb",
						"exec": [
							"const { headers } = pm.response.json();",
							"pm.test(\"Final Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Body matches string\", function () {",
							"    pm.expect(JSON.stringify(headers.Cookie)).to.include(pm.environment.get(\"cookieName\"));",
							"});",
							"",
							"console.log(\"We've tested evens \" + pm.environment.get(\"testedEvens\") + \" times\");",
							"console.log(\"We've tested odds \" + pm.environment.get(\"testedOdds\") + \" times\");",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Content-Type",
						"name": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Cookie",
						"value": "",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\"userID\": {{userID}},\"IP\": {{ipAddress}},\"Flow\":{{flowFollowed}},\"cookie\": {\"name\": {{cookieName}} }\n}"
				},
				"url": {
					"raw": "{{urlA}}/anything/{{testRunNumber}}",
					"host": [
						"{{urlA}}"
					],
					"path": [
						"anything",
						"{{testRunNumber}}"
					]
				},
				"description": "Should return whatever we pass in"
			},
			"response": []
		},
		{
			"name": "Clean Up Cookie",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "c3ac3a07-a52e-498c-96d0-e7e2c6d6e809",
						"exec": [
							"const { cookies } = pm.response.json();",
							"const cookieName = pm.environment.get(\"cookieName\");",
							"pm.test(\"Cookie has been destroyed\", function () {",
							"   ",
							"    pm.expect(cookies[cookieName]).to.not.be.ok;",
							"    // pm.expect(JSON.stringify(cookie)).to.not.include(pm.environment.get(\"cookieName\"));",
							"",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{urlA}}/cookies/delete?{{cookieName}}",
					"host": [
						"{{urlA}}"
					],
					"path": [
						"cookies",
						"delete"
					],
					"query": [
						{
							"key": "{{cookieName}}",
							"value": null
						}
					]
				}
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"id": "5db84e14-e095-4afb-bf57-debafb8daea7",
				"type": "text/javascript",
				"exec": [
					"",
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"id": "7c7ebe51-43cb-47aa-a7c0-c581ea31ef8f",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	]
}